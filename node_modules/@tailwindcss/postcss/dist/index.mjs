import U from"@alloc/quick-lru";import{compile as x,env as o}from"@tailwindcss/node";import{clearRequireCache as v}from"@tailwindcss/node/require-cache";import{Scanner as D}from"@tailwindcss/oxide";import{Features as E,transform as z}from"lightningcss";import G from"node:fs";import C from"node:path";import O from"postcss";import{normalizePath as b}from"@tailwindcss/node";import d from"node:path";var y="'",P='"';function w(){let c=new WeakSet;function a(t){let n=t.root().source?.input.file;if(!n)return;let s=t.source?.input.file;if(!s||c.has(t))return;let l=t.params[0],e=l[0]===P&&l[l.length-1]===P?P:l[0]===y&&l[l.length-1]===y?y:null;if(!e)return;let m=t.params.slice(1,-1),f="";if(m.startsWith("!")&&(m=m.slice(1),f="!"),!m.startsWith("./")&&!m.startsWith("../"))return;let g=d.posix.join(b(d.dirname(s)),m),u=d.posix.dirname(b(n)),p=d.posix.relative(u,g);p.startsWith(".")||(p="./"+p),t.params=e+f+p+e,c.add(t)}return{postcssPlugin:"tailwindcss-postcss-fix-relative-paths",AtRule:{source:a,plugin:a,config:a}}}var S=new U({maxSize:50});function R(c,a){let t=`${c}:${a.base??""}:${a.optimize??""}`;if(S.has(t))return S.get(t);let n={mtimes:new Map,compiler:null,scanner:null,css:"",optimizedCss:"",fullRebuildPaths:[]};return S.set(t,n),n}function A(c={}){let a=c.base??process.cwd(),t=c.optimize??process.env.NODE_ENV==="production";return{postcssPlugin:"@tailwindcss/postcss",plugins:[w(),{postcssPlugin:"tailwindcss",async OnceExit(n,{result:s}){o.DEBUG&&console.time("[@tailwindcss/postcss] Total time in @tailwindcss/postcss");let l=s.opts.from??"",e=R(l,c),m=C.dirname(C.resolve(l));async function f(){o.DEBUG&&console.time("[@tailwindcss/postcss] Setup compiler"),v(e.fullRebuildPaths),e.fullRebuildPaths=[];let r=await x(n.toString(),{base:m,onDependency:i=>{e.fullRebuildPaths.push(i)}});return o.DEBUG&&console.timeEnd("[@tailwindcss/postcss] Setup compiler"),r}let g=e.compiler===null;e.compiler??=await f();let u="incremental";{for(let i of e.fullRebuildPaths)s.messages.push({type:"dependency",plugin:"@tailwindcss/postcss",file:i,parent:s.opts.from});let r=s.messages.flatMap(i=>i.type!=="dependency"?[]:i.file);r.push(l);for(let i of r){let h=G.statSync(i,{throwIfNoEntry:!1})?.mtimeMs??null;if(h===null){i===l&&(u="full");continue}e.mtimes.get(i)!==h&&(u="full",e.mtimes.set(i,h))}}let p="";if(u==="full"&&!g&&(e.compiler=await f()),e.scanner===null||u==="full"){let r=(e.compiler.root==="none"?[]:e.compiler.root===null?[{base:a,pattern:"**/*"}]:[e.compiler.root]).concat(e.compiler.globs);e.scanner=new D({sources:r})}o.DEBUG&&console.time("[@tailwindcss/postcss] Scan for candidates");let B=e.scanner.scan();o.DEBUG&&console.timeEnd("[@tailwindcss/postcss] Scan for candidates");for(let r of e.scanner.files)s.messages.push({type:"dependency",plugin:"@tailwindcss/postcss",file:r,parent:s.opts.from});for(let{base:r,pattern:i}of e.scanner.globs)i===""?s.messages.push({type:"dependency",plugin:"@tailwindcss/postcss",file:r,parent:s.opts.from}):s.messages.push({type:"dir-dependency",plugin:"@tailwindcss/postcss",dir:r,glob:i,parent:s.opts.from});o.DEBUG&&console.time("[@tailwindcss/postcss] Build CSS"),p=e.compiler.build(B),o.DEBUG&&console.timeEnd("[@tailwindcss/postcss] Build CSS"),p!==e.css&&t&&(o.DEBUG&&console.time("[@tailwindcss/postcss] Optimize CSS"),e.optimizedCss=T(p,{minify:typeof t=="object"?t.minify:!0}),o.DEBUG&&console.timeEnd("[@tailwindcss/postcss] Optimize CSS")),e.css=p,o.DEBUG&&console.time("[@tailwindcss/postcss] Update PostCSS AST"),n.removeAll(),n.append(O.parse(t?e.optimizedCss:e.css,s.opts)),o.DEBUG&&console.timeEnd("[@tailwindcss/postcss] Update PostCSS AST"),o.DEBUG&&console.timeEnd("[@tailwindcss/postcss] Total time in @tailwindcss/postcss")}}]}}function T(c,{file:a="input.css",minify:t=!1}={}){function n(s){return z({filename:a,code:s,minify:t,sourceMap:!1,drafts:{customMedia:!0},nonStandard:{deepSelectorCombinator:!0},include:E.Nesting,exclude:E.LogicalProperties,targets:{safari:16<<16|1024},errorRecovery:!0}).code}return n(n(Buffer.from(c))).toString()}var H=Object.assign(A,{postcss:!0});export{H as default};
